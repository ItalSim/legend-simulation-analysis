# Optical map production

This is a subroutine of the ItalSim branch of the warwick-legend simulation module based on Geant4. Given an ordered set of coordinate pairs (X1,Y1,Z1) and (X2,Y2,Z2), construct an improved version of the LEGEND-200 concept of an "optical map".

An optical map is a tool used to simplify simulations analysis. Optical simulations in Geant4 are costly both in terms of memory and in terms of processing resources required. For a fixed geometry, it is possible to populate the entire relevant volume with photons one time in a dedicated campaign, and reference the results of that campaign, instead of simulating optics each time they are necessary for a new simulation campaign. These results are referenced by use of a 3D map of the volume, broken into small cubes called 'voxels'. Each voxel contains information about the piece of volume which it encloses, and the average detection probability of a photon which originates in that piece. A good map will have sufficiently small voxels, with sufficiently high statistics in the probability determination.

## Structure of this template

Below is a description of this optical map production template. It is assumed that the user has an appropriate version of WLGD/ItalSim installed.

### jobs

This is the directory which contains information necessary for distributed job submission to the MPIK lfs2 computing cluster. The macro used to generate the raw files for map generation should also be stored here, for documentation purposes. Jobs should always be submitted from this directory. All of the log files from job submission will write to this directory as well.

For Geant4 jobs (i.e. producing the raw files), 

jobsubmitg4.C calls
submitg4.sh which calls
rg4.sh

User-defined parameters:
- jobsubmitg4
  - int i: informs the script how many jobs should be submitted (default 100)
- submitg4
  - source command: should point to the user's .bashrc file
  - singularity exec: only the third argument should be changed, to point to rg4.sh
- rg4.sh
  - First source command: should point to the user's .bashrc file
  - Second source command: should point to the user's ItalSim directory, and the env.sh file inside
  - Third command: first part points to the WLGD executable, second part points to a macro for optical map generation (one version included in the jobs directory for reference), third part should point to this template's 'raw' output subdirectory (/output/raw).


For ROOT jobs (i.e. producing the maps),

jobsubmitroot.C calls
submitroot.sh

User-defined parameters:
- jobsubmitroot.C
  - int i: informs the script how many jobs should be submitted (default 100)
- submitroot
  - source command: should point to the user's .bashrc file
  - root command: should point to this template's 'scripts' subdirectory (/scripts)
  - The user should decide whether it is appropriate to run the builder script or the merger script (typically in that order)




It is intended to work with output from this module. The parameters may be adjusted for processing of other ROOT-based coordinate data, but this does not come with a guarantee of functionality.